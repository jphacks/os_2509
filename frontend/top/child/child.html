<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>éŸ³å£°èªè­˜ï¼†DBä¿å­˜</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center; }
        h1 { color: #333; }
        button { font-size: 1.2em; padding: 10px 20px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; }
        #startButton { background-color: #4CAF50; color: white; }
        #stopButton { background-color: #f44336; color: white; }
        #status { font-weight: bold; margin: 20px 0; min-height: 1.5em; }
        #resultText { background: #f4f4f4; border: 1px solid #ddd; padding: 15px; min-height: 100px; text-align: left; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>ğŸ™ï¸ éŸ³å£°èªè­˜ ãƒ†ã‚¹ãƒˆ</h1>
    <p>ã€ŒéŒ²éŸ³é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦è©±ã—ã¦ãã ã•ã„ã€‚</p>
    
    <button id="startButton">éŒ²éŸ³é–‹å§‹</button>
    <button id="stopButton" disabled>éŒ²éŸ³åœæ­¢</button>

    <div id="status">å¾…æ©Ÿä¸­...</div>
    <div id="resultText"></div>

    <script>
        // ãƒ–ãƒ©ã‚¦ã‚¶ãŒWeb Speech APIã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!window.SpeechRecognition) {
            alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Google Chromeãªã©ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚");
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP'; // è¨€èªã‚’æ—¥æœ¬èªã«è¨­å®š
        recognition.interimResults = true; // èªè­˜ã®é€”ä¸­çµæœã‚‚å–å¾—ã™ã‚‹
        recognition.continuous = true; // ç¶™ç¶šçš„ã«èªè­˜ã‚’è¡Œã†

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusDiv = document.getElementById('status');
        const resultTextDiv = document.getElementById('resultText');

        let finalTranscript = ''; // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆ

        recognition.onstart = () => {
            statusDiv.textContent = 'èªè­˜ä¸­... ãƒã‚¤ã‚¯ã«è©±ã—ã‹ã‘ã¦ãã ã•ã„';
            startButton.disabled = true;
            stopButton.disabled = false;
        };

        recognition.onend = () => {
            statusDiv.textContent = 'èªè­˜åœæ­¢ã€‚';
            startButton.disabled = false;
            stopButton.disabled = true;
        };

        recognition.onresult = (event) => {
            let interimTranscript = ''; // æš«å®šã®ãƒ†ã‚­ã‚¹ãƒˆ
            finalTranscript = ''; // ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ

            for (let i = 0; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆ
                    finalTranscript += transcript;
                } else {
                    // æš«å®šã®ãƒ†ã‚­ã‚¹ãƒˆ
                    interimTranscript += transcript;
                }
            }

            // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’DBã«ä¿å­˜
            if (finalTranscript) {
                console.log("ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆ:", finalTranscript);
                // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                saveToDB(finalTranscript);
                // è¡¨ç¤ºã‚’æ›´æ–°
                resultTextDiv.innerHTML += `<div><strong>ç¢ºå®š:</strong> ${finalTranscript}</div>`;
            }
            
            // ç”»é¢ã«ã¯æš«å®šãƒ†ã‚­ã‚¹ãƒˆã‚‚è¡¨ç¤ºï¼ˆæ“ä½œæ„Ÿå‘ä¸Šã®ãŸã‚ï¼‰
            statusDiv.textContent = `èªè­˜ä¸­... [æš«å®š]: ${interimTranscript}`;
        };

        recognition.onerror = (event) => {
            statusDiv.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error;
            startButton.disabled = false;
            stopButton.disabled = true;
        };

        // éŒ²éŸ³é–‹å§‹ãƒœã‚¿ãƒ³
        startButton.onclick = () => {
            finalTranscript = ''; // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            resultTextDiv.innerHTML = ''; // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            recognition.start();
        };

        // éŒ²éŸ³åœæ­¢ãƒœã‚¿ãƒ³
        stopButton.onclick = () => {
            recognition.stop();
        };

        // ã‚µãƒ¼ãƒãƒ¼(save_text.php)ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
        async function saveToDB(text) {
            statusDiv.textContent = 'DBã«ä¿å­˜ä¸­...';

            const params = new URLSearchParams();
            params.append('soundtext', text); // 'soundtext'ã¨ã„ã†ã‚­ãƒ¼ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ãƒƒãƒˆ

            try {
                const response = await fetch('save_audio_text.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                });
                
                const result = await response.json(); // PHPã‹ã‚‰ã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…ã¤

                if (result.status === 'success') {
                    statusDiv.textContent = `ã€Œ${text}ã€ã‚’DBã«ä¿å­˜ã—ã¾ã—ãŸï¼`;
                    console.log('DBä¿å­˜æˆåŠŸ:', result);
                } else {
                    statusDiv.textContent = 'DBä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message;
                    console.error('DBä¿å­˜å¤±æ•—:', result.message);
                }
            } catch (error) {
                statusDiv.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                console.error('Fetchã‚¨ãƒ©ãƒ¼:', error);
            }
        }
    </script>

</body>
</html>
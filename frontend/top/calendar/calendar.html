<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>つながり日記 – 絵日記カレンダー</title>

  <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Sawarabi+Mincho&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="../../shared/auth.js" data-root="../../../" defer></script>

</head>
<body>
  <div class="page">
    <div class="spine" aria-hidden="true"></div>
    <div class="punches" aria-hidden="true"></div>
    <div class="tape tl" aria-hidden="true"></div>
    <div class="tape tr" aria-hidden="true"></div>

    <div class="content">
      <div class="top-gap" aria-hidden="true"></div>
      <h1 class="title">絵日記カレンダー</h1>
      <div class="spacer" aria-hidden="true"></div>

      <div class="board-wrap" id="boardWrap">
        <div class="pin" id="pin" aria-hidden="true"></div>

        <svg class="ropes" id="ropes" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
          <line id="ropeL" x1="50" y1="10" x2="20" y2="90"></line>
          <line id="ropeR" x1="50" y1="10" x2="80" y2="90"></line>
        </svg>

        <section class="board" aria-label="吊り下げカレンダー" id="board">
          <div class="swipe-hint left" id="hintLeft"></div>
          <div class="swipe-hint right" id="hintRight"></div>

          <header class="cal-head">
            <button class="nav-btn" id="prevBtn" aria-label="前の月へ">‹</button>
            <div class="cal-month" id="monthLabel">YYYY年M月</div>
            <button class="nav-btn" id="nextBtn" aria-label="次の月へ">›</button>
          </header>

          <div class="cal-body" id="calBody">
            <div class="dow-row" id="dowRow"></div>
            <div class="grid" id="grid"></div>
          </div>
        </section>
      </div>

      <p class="hint">左右スワイプで表示する月日を変更</p>
    </div>
  </div>

  <div class="copyright">© <span id="y"></span> つながり日記</div>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    // ← 追加：遷移先エントリーページ
    const ENTRY_PAGE = '/os_2509/frontend/top/parent/parent.html';

    const startOfWeek = 0;
    const dowHead = ['日','月','火','水','木','金','土'];

    // ← DBから受け取る「YYYY-MM-DD: [id,...]」のマップ
    let diaryIndex = {};
    function hasDiary(dateStr){ return !!diaryIndex[dateStr] && diaryIndex[dateStr].length > 0; }
    
    // 配列の先頭( [0] )ではなく、配列内の最小値(一番若いID)を返すように変更
    function firstDiaryId(dateStr){ 
      if (!hasDiary(dateStr)) { return null; }
      // 配列内のIDのうち、最小のID（一番若い番号）を返す
      return Math.min(...diaryIndex[dateStr]);
    }

    function eventEmoji(y,m,d){
      const md = `${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      switch(md){
        case '01-01': return '🎍'; case '02-14': return '💝'; case '03-03': return '🎎';
        case '04-29': return '🌸'; case '05-05': return '🎏'; case '07-07': return '🎋';
        case '08-15': return '🏮'; case '09-15': return '🌕'; case '10-31': return '🎃';
        case '12-24': return '🎄'; case '12-31': return '🧧'; default: return '';
      }
    }

    const monthLabel = document.getElementById('monthLabel');
    const dowRow = document.getElementById('dowRow');
    const grid = document.getElementById('grid');
    const board = document.getElementById('board');

    const now = new Date();
    let viewY = now.getFullYear();
    let viewM = now.getMonth(); // 0..11

    function jpMonth(y,m){ return `${y}年${m}月`; }
    function ymd(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

    function renderDow(){
      dowRow.innerHTML = '';
      for(let i=0;i<7;i++){
        const w = (i + startOfWeek) % 7;
        const el = document.createElement('div');
        el.className = 'dow' + (w===0?' sun' : w===6?' sat':'');
        el.textContent = dowHead[w];
        dowRow.appendChild(el);
      }
    }

    function defaultMarkSVG(){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M9.5 16.2L5.8 12.5l-1.3 1.3 5 5 10-10-1.3-1.3z"/>
        </svg>
      `;
    }
    function createMarkEl(iconName='default', svgHTML=defaultMarkSVG()){
      const span = document.createElement('span');
      span.className = 'mark';
      span.dataset.icon = iconName;
      span.innerHTML = svgHTML;
      return span;
    }

    function gotoEntry({ id=null, date=null }) {
      const url = new URL(ENTRY_PAGE, location.origin);
      if (id != null)   url.searchParams.set('id', String(id));
      else if (date)    url.searchParams.set('date', date);

      const root = document.querySelector('.page');
      if (root) {
        root.classList.add('leaving');
        setTimeout(()=>{ window.location.href = url.toString(); }, 200);
      } else {
        window.location.href = url.toString();
      }
    }

    function renderMonth(y, m){
      board.classList.remove('slide-left','slide-right');
      grid.innerHTML = '';
      monthLabel.textContent = jpMonth(y, m);

      const first = new Date(y, m-1, 1);
      const lastDate = new Date(y, m, 0).getDate();
      const firstDow = first.getDay();
      const startPad = (firstDow - startOfWeek + 7) % 7;

      for(let i=0;i<startPad;i++){
        const pad = document.createElement('div');
        pad.className = 'cell';
        grid.appendChild(pad);
      }

      for(let d=1; d<=lastDate; d++){
        const wd = (startPad + (d-1)) % 7;
        const cell = document.createElement('div');
        cell.className = 'cell' + (wd===0?' sun' : wd===6?' sat':'');

        const num = document.createElement('div'); num.className='d'; num.textContent=d;
        const emo = document.createElement('div'); emo.className='emo'; emo.textContent = eventEmoji(y,m,d);
        const dateStr = ymd(y,m,d);

        let mark = null;
        if (hasDiary(dateStr)) { mark = createMarkEl('default'); }

        const btn = document.createElement('button');
        btn.setAttribute('aria-label', `${dateStr}を開く`);
        btn.addEventListener('click', () => {
          if (hasDiary(dateStr)) {
            const id = firstDiaryId(dateStr); // ← ここで最小のIDが取得される
            gotoEntry({ id: id ?? null, date: dateStr });
          } else {
            alert('この日付は絵日記が存在しません');
          }
        });

        cell.append(num, emo);
        if (mark) cell.append(mark);
        cell.append(btn);
        grid.appendChild(cell);
      }

      const rem = (startPad + lastDate) % 7;
      if(rem !== 0){
        for(let i=rem; i<7; i++){
          const pad = document.createElement('div');
          pad.className = 'cell';
          grid.appendChild(pad);
        }
      }

      layoutRopes();
    }

    function shiftMonth(delta){
      viewM += delta;
      if(viewM < 0){ viewM = 11; viewY--; }
      if(viewM > 11){ viewM = 0;  viewY++; }
      board.classList.add(delta > 0 ? 'slide-left' : 'slide-right');
      renderMonth(viewY, viewM+1);
    }

    (function attachSwipe(){
      const host = board, hintL = document.getElementById('hintLeft'), hintR = document.getElementById('hintRight');
      let sx=0, dx=0, down=false; const threshold=40;
      function showHints(){
        const a=Math.min(1, Math.max(0,   dx/threshold));
        const b=Math.min(1, Math.max(0, -dx/threshold));
        if(a>0){ hintLeft.style.opacity=0.2+0.6*a; hintLeft.style.transform=`translate(${(-18+18*a).toFixed(1)}px, -50%) scale(${(0.85+0.25*a).toFixed(2)})`; }
        else{ hintLeft.style.opacity=0; hintLeft.style.transform=`translate(-18px,-50%) scale(.85)`; }
        if(b>0){ hintRight.style.opacity=0.2+0.6*b; hintRight.style.transform=`translate(${(18-18*b).toFixed(1)}px, -50%) scale(${(0.85+0.25*b).toFixed(2)})`; }
        else{ hintRight.style.opacity=0; hintRight.style.transform=`translate(18px,-50%) scale(.85)`; }
      }
      function clearHints(){ hintLeft.style.opacity=0; hintRight.style.opacity=0; hintLeft.style.transform=`translate(-18px,-50%) scale(.85)`; hintRight.style.transform=`translate(18px,-50%) scale(.85)`; }
      host.addEventListener('touchstart', e=>{down=true; sx=e.touches[0].clientX; dx=0; clearHints();},{passive:true});
      host.addEventListener('touchmove',  e=>{if(!down)return; dx=e.touches[0].clientX - sx; showHints();},{passive:true});
      host.addEventListener('touchend',   ()=>{if(!down)return; down=false; if(dx>threshold)shiftMonth(-1); else if(dx<-threshold)shiftMonth(1); clearHints();},{passive:true});
    })();

    function layoutRopes(){
      const wrap=document.getElementById('boardWrap');
      const pin=document.getElementById('pin');
      const ropes=document.getElementById('ropes');
      const ropeL=document.getElementById('ropeL');
      const ropeR=document.getElementById('ropeR');
      const board=document.getElementById('board');

      const wrapRect=wrap.getBoundingClientRect();
      const pinRect=pin.getBoundingClientRect();
      const boardRect=board.getBoundingClientRect();

      const svgW=wrapRect.width;
      const svgH=Math.max(boardRect.top - wrapRect.top, 10);
      ropes.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);
      ropes.style.width=svgW+'px'; ropes.style.height=svgH+'px';

      const pinX=pinRect.left + pinRect.width/2 - wrapRect.left;
      const pinY=pinRect.top + pinRect.height - wrapRect.top;

      const insetX=12, insetY=8;
      const blX=boardRect.left + insetX - wrapRect.left;
      const brX=boardRect.right - insetX - wrapRect.left;
      const bY =boardRect.top + insetY - wrapRect.top;

      ropeL.setAttribute('x1', pinX); ropeL.setAttribute('y1', pinY);
      ropeL.setAttribute('x2', blX ); ropeL.setAttribute('y2', bY  );
      ropeR.setAttribute('x1', pinX); ropeR.setAttribute('y1', pinY);
      ropeR.setAttribute('x2', brX ); ropeR.setAttribute('y2', bY  );
    }

    window.addEventListener('resize', layoutRopes, {passive:true});
    window.addEventListener('orientationchange', () => { setTimeout(layoutRopes, 200); }, {passive:true});

    async function init(){
      renderDow();
      renderMonth(viewY, viewM+1);

      try{
        const url = '/os_2509/frontend/top/calendar/diary_dates.php?ts=' + Date.now();
        const res = await fetch(url, { cache:'no-store', credentials:'same-origin' });
        if(!res.ok){
          console.error('diary_dates HTTP error', res.status, await res.text());
        }else{
          const json = await res.json();
          console.log('diary_dates payload:', json);

          if(json.ok && json.days){
            // ★ 受け取ったキーを “YYYY-MM-DD” に強制正規化（先頭10文字 + trim）
            const normalized = {};
            for (const k of Object.keys(json.days)) {
              const k2 = String(k).trim().slice(0, 10); // "2025-10-17 00:00:00" → "2025-10-17"
              if (!normalized[k2]) normalized[k2] = [];
              const arr = Array.isArray(json.days[k]) ? json.days[k] : [json.days[k]];
              normalized[k2].push(...arr);
            }
            diaryIndex = normalized;
            console.log('normalized diaryIndex keys:', Object.keys(diaryIndex)); // 確認ログ
            renderMonth(viewY, viewM+1); // マーク反映
          } else {
            console.warn('diary_dates unexpected JSON', json);
          }
        }
      }catch(e){
        console.error('diary_dates fetch error', e);
      }

      layoutRopes();
    }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); } else { init(); }

    document.getElementById('prevBtn')?.addEventListener('click', () => shiftMonth(-1));
    document.getElementById('nextBtn')?.addEventListener('click', () => shiftMonth(1));
  </script>
</body>
</html>
